<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Veterinário</title>
    <!-- Tailwind CSS para um design moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Estilos personalizados */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .modal { transition: all 0.3s ease-in-out; }
        .hidden { display: none; }
        .tab-button { transition: all 0.2s; padding: 8px 16px; border-radius: 8px; border: 1px solid transparent; font-weight: 500; text-align: center; }
        .tab-button.active { background-color: #8b5cf6; color: white; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .tab-button:not(.active):hover { background-color: #c4b5fd; }
        .tab-content { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Estilos para Toast (Notificação) */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateX(100%);
            z-index: 1000;
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: #22c55e; /* green-500 */ }
        .toast.error { background-color: #ef4444; /* red-500 */ }
        .toast.warning { background-color: #f97316; /* orange-500 */ }
    </style>
</head>
<body class="bg-purple-100 font-sans">

    <!-- ==== CONTAINER PARA TOASTS ==== -->
    <div id="toast-container"></div>

    <!-- ==== TELA DE LOGIN ==== -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Controle Veterinário</h1>
            <p id="login-error" class="text-red-500 text-center mb-4 hidden"></p>
            <form id="login-form">
                <div class="mb-4"><label for="email" class="block text-gray-700 mb-2">Email</label><input type="email" id="email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required></div>
                <div class="mb-6"><label for="password" class="block text-gray-700 mb-2">Senha</label><input type="password" id="password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required></div>
                <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors">Entrar</button>
            </form>
        </div>
    </div>

    <!-- ==== APLICAÇÃO PRINCIPAL ==== -->
    <div id="app-screen" class="hidden">
        <header class="bg-purple-900 text-white shadow-md p-4 flex justify-between items-center">
            <div class="w-1/4"></div><h1 class="text-2xl md:text-3xl font-bold text-center flex-grow">Controle Veterinário</h1><div class="w-1/4 flex justify-end"><button id="logout-button" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors">Sair</button></div>
        </header>

        <main class="p-4 md:p-8">
            <div class="flex justify-center mb-6"><nav class="flex flex-wrap space-x-2 md:space-x-4 bg-purple-200 p-1 rounded-lg" aria-label="Tabs"><button class="tab-button active" data-tab="dashboard">Dashboard</button><button class="tab-button" data-tab="pets">Pets</button><button class="tab-button" data-tab="vaccines">Vacinas</button><button class="tab-button" data-tab="parasite-control">Controle Parasitário</button><button class="tab-button" data-tab="stock">Estoque</button></nav></div>
            <div id="filters-container" class="mb-6 p-4 bg-purple-800 rounded-lg shadow-sm flex flex-col md:flex-row items-center gap-4"><div class="w-full md:flex-grow"><label for="universal-search" class="sr-only">Buscar</label><input type="text" id="universal-search" placeholder="Buscar por Pet, Tutor ou Produto..." class="border rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-purple-500"></div><div id="date-filters" class="hidden w-full md:w-auto md:flex items-center gap-2"><label class="text-sm font-medium text-purple-100">Próxima Dose Entre:</label><input type="date" id="start-date-filter" class="border rounded-lg px-3 py-2"><span class="text-purple-300">e</span><input type="date" id="end-date-filter" class="border rounded-lg px-3 py-2"><button id="clear-filters-button" title="Limpar filtros" class="bg-purple-200 text-purple-800 p-2 rounded-lg hover:bg-purple-300"><i class="fas fa-times"></i></button></div></div>
            <div id="tab-contents"><div id="dashboard-tab" class="tab-content"></div><div id="pets-tab" class="tab-content hidden"></div><div id="stock-tab" class="tab-content hidden"></div><div id="vaccines-tab" class="tab-content hidden"></div><div id="parasite-control-tab" class="tab-content hidden"></div></div>
            <div id="pet-details-view" class="hidden mt-8"></div>
        </main>
    </div>

    <!-- ==== MODAIS ==== -->
    <div id="pet-modal" class="fixed inset-0 z-50 hidden modal-backdrop overflow-y-auto p-4 flex"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg modal m-auto"><h2 id="pet-modal-title" class="text-xl font-bold mb-4"></h2><form id="pet-form"><input type="hidden" id="pet-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="pet-name" placeholder="Nome do Pet" class="border p-2 rounded w-full" required><input type="text" id="pet-species" placeholder="Espécie (Cão, Gato)" class="border p-2 rounded w-full" required><input type="text" id="pet-breed" placeholder="Raça" class="border p-2 rounded w-full" required><input type="text" id="pet-color" placeholder="Cor da Pelagem" class="border p-2 rounded w-full"><input type="number" id="pet-weight" placeholder="Peso (kg)" step="0.1" class="border p-2 rounded w-full"><div><label for="pet-birthdate" class="text-sm text-gray-600">Nascimento</label><input type="date" id="pet-birthdate" class="border p-2 rounded w-full" required></div><input type="text" id="tutor-name" placeholder="Nome do Tutor" class="border p-2 rounded w-full" required><input type="tel" id="tutor-contact" placeholder="Contato do Tutor" class="border p-2 rounded w-full" required></div><div class="mt-4 md:col-span-2 flex items-center"><input type="checkbox" id="pet-daycare" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"><label for="pet-daycare" class="ml-2 block text-sm text-gray-900">Pet de Creche/Hotel?</label></div><div class="mt-6 flex justify-end"><button type="button" class="close-modal bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2">Cancelar</button><button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded">Salvar</button></div></form></div></div>
    <div id="record-modal" class="fixed inset-0 z-50 hidden modal-backdrop overflow-y-auto p-4 flex"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg modal m-auto"><h2 id="record-modal-title" class="text-xl font-bold mb-4"></h2><form id="record-form"><input type="hidden" id="record-id"><input type="hidden" id="record-type"><div class="mb-4"><label class="block text-gray-700 mb-2">Produto/Vacina</label><select id="product-select" class="w-full border p-2 rounded"></select></div><div id="other-product-container" class="hidden mb-4 space-y-2"><label class="block text-gray-700">Nome do Produto (Outros)</label><input type="text" id="other-product-name" class="w-full border p-2 rounded"></div><div class="mb-4"><label class="block text-gray-700 mb-2">Data da Aplicação</label><input type="date" id="application-date" class="w-full border p-2 rounded" required></div><div class="flex items-center mb-4"><input type="checkbox" id="applied-elsewhere" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"><label for="applied-elsewhere" class="ml-2 block text-sm text-gray-900">Aplicado noutro local (não debitar do stock)</label></div><div class="mt-6 flex justify-end"><button type="button" class="close-modal bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2">Cancelar</button><button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded">Salvar</button></div></form></div></div>
    <div id="consultation-modal" class="fixed inset-0 z-50 hidden modal-backdrop overflow-y-auto p-4 flex"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl modal m-auto"><h2 id="consultation-modal-title" class="text-xl font-bold mb-4"></h2><form id="consultation-form"><input type="hidden" id="consultation-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"><div class="md:col-span-2"><label class="block text-gray-700 mb-2">Queixa Principal / Motivo</label><textarea id="consultation-complaint" class="w-full border p-2 rounded" rows="2" required></textarea></div><div><label class="block text-gray-700 mb-2">Data da Consulta</label><input type="date" id="consultation-date" class="w-full border p-2 rounded" required></div><div><label class="block text-gray-700 mb-2">Peso (kg)</label><input type="number" id="consultation-weight" step="0.1" class="w-full border p-2 rounded" required></div><div class="md:col-span-2"><label class="block text-gray-700 mb-2">Exame Físico e Observações</label><textarea id="consultation-exam" class="w-full border p-2 rounded" rows="4"></textarea></div><div class="md:col-span-2"><label class="block text-gray-700 mb-2">Diagnóstico(s)</label><textarea id="consultation-diagnosis" class="w-full border p-2 rounded" rows="2"></textarea></div><div class="md:col-span-2"><label class="block text-gray-700 mb-2">Tratamento / Prescrição</label><textarea id="consultation-treatment" class="w-full border p-2 rounded" rows="3"></textarea></div><div class="md:col-span-2"><label class="block text-gray-700 mb-2">Data do Retorno (Opcional)</label><input type="date" id="consultation-followup" class="w-full border p-2 rounded"></div></div><div class="md:col-span-2 mt-6 border-t pt-4"><div class="flex justify-between items-center mb-2"><h3 class="text-lg font-semibold text-gray-700">Procedimentos Realizados na Consulta</h3><button type="button" id="add-procedure-row-btn" class="bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">+ Adicionar Procedimento</button></div><div id="consultation-procedures-container" class="space-y-2"></div></div><div class="mt-6 flex justify-end"><button type="button" class="close-modal bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2">Cancelar</button><button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded">Salvar Consulta</button></div></form></div></div>
    <div id="confirm-modal" class="fixed inset-0 z-50 hidden modal-backdrop overflow-y-auto p-4 flex"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm modal m-auto"><h2 class="text-lg font-bold mb-4">Confirmar</h2><p id="confirm-modal-text" class="mb-6"></p><div class="flex justify-end"><button id="cancel-delete" class="bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2">Cancelar</button><button id="confirm-delete" class="bg-orange-600 text-white px-4 py-2 rounded">Confirmar</button></div></div></div>
    
    <div id="product-catalog-modal" class="fixed inset-0 z-50 hidden modal-backdrop overflow-y-auto p-4 flex"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg modal m-auto"><h2 id="product-catalog-modal-title" class="text-xl font-bold mb-4"></h2><form id="product-catalog-form"><input type="hidden" id="product-catalog-id"><div class="space-y-4"><div><label class="block text-gray-700">Nome do Produto</label><input type="text" id="product-catalog-name" class="w-full border p-2 rounded" required></div><div><label class="block text-gray-700">Categoria</label><select id="product-catalog-category" class="w-full border p-2 rounded" required><option value="Vacinas">Vacinas</option><option value="Controle Parasitário">Controle Parasitário</option><option value="Medicamentos">Medicamentos</option><option value="Descartáveis">Descartáveis</option></select></div><div><label class="block text-gray-700">Unidade (ex: Dose, Comprimido)</label><input type="text" id="product-catalog-unit" class="w-full border p-2 rounded"></div><div><label class="block text-gray-700">Alerta de Estoque Mínimo</label><input type="number" id="product-catalog-min-stock" class="w-full border p-2 rounded" required min="0"></div></div><div class="mt-6 flex justify-end"><button type="button" class="close-modal bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2">Cancelar</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar Produto</button></div></form></div></div>
    <div id="stock-details-modal" class="fixed inset-0 z-50 hidden modal-backdrop overflow-y-auto p-4 flex"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl modal m-auto"><h2 id="stock-details-modal-title" class="text-xl font-bold mb-4">Detalhes do Produto</h2><div id="stock-details-content"></div><div class="mt-6 flex justify-end"><button type="button" class="close-modal bg-gray-300 text-gray-800 px-4 py-2 rounded">Fechar</button></div></div></div>
    <div id="lote-entry-modal" class="fixed inset-0 z-50 hidden modal-backdrop overflow-y-auto p-4 flex"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg modal m-auto"><h2 class="text-xl font-bold mb-4">Registrar Entrada de Lote</h2><form id="lote-entry-form"><input type="hidden" id="lote-entry-product-id"><div class="space-y-4"><div><label class="block text-gray-700 mb-2">Quantidade</label><input type="number" id="lote-quantity" class="w-full border p-2 rounded" required min="1"></div><div><label class="block text-gray-700 mb-2">Data de Validade</label><input type="date" id="lote-expiry" class="w-full border p-2 rounded" required></div></div><div class="mt-6 flex justify-end"><button type="button" class="close-modal bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2">Cancelar</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar Lote</button></div></form></div></div>
    <div id="manual-deduction-modal" class="fixed inset-0 z-50 hidden modal-backdrop overflow-y-auto p-4 flex"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg modal m-auto"><h2 class="text-xl font-bold mb-4">Baixa Manual de Estoque</h2><form id="manual-deduction-form"><input type="hidden" id="deduction-product-id"><div class="space-y-4"><p class="text-sm">Produto: <strong id="deduction-product-name"></strong></p><div><label class="block text-gray-700 mb-2">Quantidade para Dar Baixa</label><input type="number" id="deduction-quantity" class="w-full border p-2 rounded" required min="1"></div></div><div class="mt-6 flex justify-end"><button type="button" class="close-modal bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2">Cancelar</button><button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded">Confirmar Baixa</button></div></form></div></div>
    <div id="stock-adjustment-modal" class="fixed inset-0 z-50 hidden modal-backdrop overflow-y-auto p-4 flex"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg modal m-auto"><h2 class="text-xl font-bold mb-4">Ajuste de Estoque (Baixa Manual)</h2><form id="stock-adjustment-form"><input type="hidden" id="adjustment-lote-id"><div class="space-y-4"><p class="text-sm">Produto: <strong id="adjustment-product-name"></strong></p><p class="text-sm">Quantidade atual no lote: <strong id="adjustment-current-stock"></strong></p><div><label class="block text-gray-700 mb-2">Quantidade a Remover</label><input type="number" id="adjustment-quantity" class="w-full border p-2 rounded" required min="1"></div></div><div class="mt-6 flex justify-end"><button type="button" class="close-modal bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2">Cancelar</button><button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded">Confirmar Baixa</button></div></form></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, query, where, Timestamp, onSnapshot, updateDoc, deleteDoc, writeBatch, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyBdjJo5vLl-GqZuqn4Fzp0MRv0qmanaz7A", authDomain: "vetcontrol-3031f.firebaseapp.com", projectId: "vetcontrol-3031f", storageBucket: "vetcontrol-3031f.appspot.com", messagingSenderId: "244279756437", appId: "1:244279756437:web:d26d54d425d7d516d8fd9c" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const loginError = document.getElementById('login-error');
        let isAppInitialized = false;
        let unsubscribeListeners = [];

        onAuthStateChanged(auth, user => { if (user && !isAppInitialized) { isAppInitialized = true; loginScreen.classList.add('hidden'); appScreen.classList.remove('hidden'); initializeAppLogic(); } else if (!user) { loginScreen.classList.remove('hidden'); appScreen.classList.add('hidden'); unsubscribeListeners.forEach(unsub => unsub()); unsubscribeListeners = []; isAppInitialized = false; }});
        loginForm.addEventListener('submit', e => { e.preventDefault(); const email = document.getElementById('email').value; const password = document.getElementById('password').value; signInWithEmailAndPassword(auth, email, password).catch(err => { loginError.textContent = "Email ou senha inválidos."; loginError.classList.remove('hidden'); }); });
        logoutButton.addEventListener('click', () => signOut(auth));

        function initializeAppLogic() {
            const mainContent = document.querySelector('#app-screen main');
            const petDetailsView = document.getElementById('pet-details-view');
            const petModal = document.getElementById('pet-modal'), petForm = document.getElementById('pet-form');
            const recordModal = document.getElementById('record-modal'), recordForm = document.getElementById('record-form');
            const consultationModal = document.getElementById('consultation-modal'), consultationForm = document.getElementById('consultation-form');
            const confirmModal = document.getElementById('confirm-modal');
            const productCatalogModal = document.getElementById('product-catalog-modal'), productCatalogForm = document.getElementById('product-catalog-form');
            const stockAdjustmentModal = document.getElementById('stock-adjustment-modal'), stockAdjustmentForm = document.getElementById('stock-adjustment-form');
            const manualDeductionModal = document.getElementById('manual-deduction-modal'), manualDeductionForm = document.getElementById('manual-deduction-form');
            const loteEntryForm = document.getElementById('lote-entry-form');
            const universalSearch = document.getElementById('universal-search'), dateFiltersContainer = document.getElementById('date-filters'), startDateFilter = document.getElementById('start-date-filter'), endDateFilter = document.getElementById('end-date-filter'), clearFiltersButton = document.getElementById('clear-filters-button');

            let allPets = [], allRecords = [], allConsultations = [], allStockProducts = [], allStockLots = [];
            let currentPetId = null, activeTab = 'dashboard', stockCategoryFilter = 'Todos';

            // --- FUNÇÕES DE UI E MODAIS ---
            const showToast = (message, type = 'success') => { const toastContainer = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.textContent = message; toast.className = `toast ${type}`; toastContainer.appendChild(toast); setTimeout(() => { toast.classList.add('show'); }, 10); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000); };
            const openModal = (modal) => modal.classList.replace('hidden', 'flex');
            const closeModal = (modal) => modal.classList.replace('flex', 'hidden');
            document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-backdrop'))));
            function openConfirmModal(message, onConfirm) { document.getElementById('confirm-modal-text').textContent = message; openModal(confirmModal); const confirmBtn = document.getElementById('confirm-delete'); const cancelBtn = document.getElementById('cancel-delete'); const confirmHandler = () => { onConfirm(); closeModal(confirmModal); cleanup(); }; const cancelHandler = () => { closeModal(confirmModal); cleanup(); }; const cleanup = () => { confirmBtn.removeEventListener('click', confirmHandler); cancelBtn.removeEventListener('click', cancelHandler); }; confirmBtn.addEventListener('click', confirmHandler); cancelBtn.addEventListener('click', cancelHandler); }
            const checkDaycareCompliance = (pet, records) => { if (!pet.isDaycare) return { compliant: true }; const petRecords = records.filter(r => r.petId === pet.id); const requiredVaccines = ["V10", "Giardia", "Raiva"]; const appliedVaccines = petRecords.filter(r => r.tipoEvento === 'Vacina' && !r.aplicadoExternamente).map(r => r.nomeProduto); const hasAllVaccines = requiredVaccines.every(v => appliedVaccines.includes(v)); const today = new Date(); today.setHours(0,0,0,0); const hasValidParasiteControl = petRecords.some(r => r.tipoEvento === 'Controle Parasitário' && r.proximaData.toDate() >= today); return { compliant: hasAllVaccines && hasValidParasiteControl }; };

            // --- FUNÇÕES DE SETUP DE MODAIS E AÇÕES DE PETS ---
            const openAddPetModal = () => { petForm.reset(); document.getElementById('pet-id').value = ''; document.getElementById('pet-modal-title').textContent = 'Adicionar Novo Pet'; openModal(petModal); };
            const openEditPetModal = (petId) => { const pet = allPets.find(p => p.id === petId); if (!pet) return; petForm.reset(); document.getElementById('pet-id').value = pet.id; document.getElementById('pet-name').value = pet.nome; document.getElementById('pet-species').value = pet.especie; document.getElementById('pet-breed').value = pet.raca; document.getElementById('pet-color').value = pet.corPelagem || ''; document.getElementById('pet-weight').value = pet.peso || ''; document.getElementById('pet-birthdate').value = new Date(pet.dataNascimento.toMillis()).toISOString().split('T')[0]; document.getElementById('tutor-name').value = pet.nomeTutor; document.getElementById('tutor-contact').value = pet.contatoTutor; document.getElementById('pet-daycare').checked = pet.isDaycare || false; document.getElementById('pet-modal-title').textContent = 'Editar Pet'; openModal(petModal); };
            async function deletePet(petId) { const batch = writeBatch(db); const recordsQuery = query(collection(db, 'registrosSaude'), where('petId', '==', petId)); const recordsSnap = await getDocs(recordsQuery); recordsSnap.forEach(recordDoc => batch.delete(recordDoc.ref)); const consultationsQuery = query(collection(db, 'consultas'), where('petId', '==', petId)); const consultationsSnap = await getDocs(consultationsQuery); consultationsSnap.forEach(consultDoc => batch.delete(consultDoc.ref)); batch.delete(doc(db, 'pets', petId)); await batch.commit(); showToast('Pet e todo seu histórico foram excluídos.', 'success'); }
            function attachPetActionListeners() { document.getElementById('add-pet-button-main')?.addEventListener('click', openAddPetModal); document.querySelectorAll('.edit-pet-btn').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); openEditPetModal(btn.dataset.petId); })); document.querySelectorAll('.delete-pet-btn').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); const petId = btn.dataset.petId; const pet = allPets.find(p=>p.id===petId); const petName = pet ? pet.nome : 'este pet'; openConfirmModal(`Deseja excluir ${petName} e todo o seu histórico (incluindo consultas)?`, () => deletePet(petId)); })); document.querySelectorAll('#pets-tab tr[data-pet-id]').forEach(row => row.addEventListener('click', () => showPetDetailsView(row.dataset.petId))); }
            
            const setupRecordModal = (type, record = null) => {
                recordForm.reset();
                const productSelect = document.getElementById('product-select');
                const otherProductContainer = document.getElementById('other-product-container');
                
                document.getElementById('record-id').value = record ? record.id : '';
                document.getElementById('record-type').value = type;
                document.getElementById('record-modal-title').textContent = `${record ? 'Editar' : 'Registrar'} ${type}`;
                
                const category = type === 'Vacina' ? 'Vacinas' : (type === 'Controle Parasitário' ? 'Controle Parasitário' : 'Medicamentos');
                const availableProducts = allStockProducts.filter(p => p.categoria === category);
                
                productSelect.innerHTML = '<option value="">Selecione um produto</option>' + availableProducts.map(p => `<option value="${p.nomeProduto}">${p.nomeProduto}</option>`).join('') + '<option value="Outros">Outros</option>';

                otherProductContainer.classList.add('hidden');
                document.getElementById('other-product-name').value = '';

                if (record) {
                    const isProductInList = availableProducts.some(p => p.nomeProduto === record.nomeProduto);
                    if (isProductInList) {
                        productSelect.value = record.nomeProduto;
                    } else {
                        productSelect.value = 'Outros';
                        otherProductContainer.classList.remove('hidden');
                        document.getElementById('other-product-name').value = record.nomeProduto;
                    }
                    document.getElementById('application-date').value = new Date(record.dataAplicacao.toMillis()).toISOString().split('T')[0];
                    document.getElementById('applied-elsewhere').checked = record.aplicadoExternamente || false;
                } else {
                    document.getElementById('application-date').valueAsDate = new Date();
                }
                openModal(recordModal);
            };

             const setupConsultationModal = (consultation = null) => {
                consultationForm.reset();
                const proceduresContainer = document.getElementById('consultation-procedures-container');
                proceduresContainer.innerHTML = ''; 

                document.getElementById('consultation-id').value = consultation ? consultation.id : '';
                document.getElementById('consultation-modal-title').textContent = `${consultation ? 'Editar' : 'Nova'} Consulta`;
                const pet = allPets.find(p => p.id === currentPetId);

                if (consultation) {
                    document.getElementById('consultation-date').value = new Date(consultation.dataConsulta.toMillis()).toISOString().split('T')[0];
                    document.getElementById('consultation-weight').value = consultation.peso || '';
                    document.getElementById('consultation-complaint').value = consultation.queixaPrincipal || '';
                    document.getElementById('consultation-exam').value = consultation.exameFisico || '';
                    document.getElementById('consultation-diagnosis').value = consultation.diagnostico || '';
                    document.getElementById('consultation-treatment').value = consultation.tratamento || '';
                    document.getElementById('consultation-followup').value = consultation.dataRetorno ? new Date(consultation.dataRetorno.toMillis()).toISOString().split('T')[0] : '';
                    
                    if (consultation.procedimentos && consultation.procedimentos.length > 0) {
                        consultation.procedimentos.forEach(proc => addProcedureRow(proc));
                    }
                } else {
                    document.getElementById('consultation-date').valueAsDate = new Date();
                    document.getElementById('consultation-weight').value = pet.peso || '';
                }

                document.getElementById('add-procedure-row-btn').onclick = () => addProcedureRow(); 
                openModal(consultationModal);
            };

             const addProcedureRow = (procedureData = null) => {
                const container = document.getElementById('consultation-procedures-container');
                const procedureId = `proc_${Date.now()}`;
                const procedureRow = document.createElement('div');
                procedureRow.className = 'grid grid-cols-5 gap-2 items-center';
                procedureRow.id = procedureId;

                const allProducts = allStockProducts;

                procedureRow.innerHTML = `
                    <select class="col-span-2 border p-2 rounded procedure-product">
                        <option value="">Selecione um produto...</option>
                        ${allProducts.map(p => `<option value="${p.id}" ${procedureData && procedureData.productId === p.id ? 'selected' : ''}>${p.nomeProduto} (${p.categoria})</option>`).join('')}
                    </select>
                    <input type="number" class="border p-2 rounded procedure-quantity" value="${procedureData ? procedureData.quantidade : 1}" min="1">
                    <div class="flex items-center">
                        <input type="checkbox" id="proc-applied-elsewhere-${procedureId}" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500 procedure-external" ${procedureData && procedureData.aplicadoExternamente ? 'checked' : ''}>
                        <label for="proc-applied-elsewhere-${procedureId}" class="ml-2 text-xs text-gray-700">Externo</label>
                    </div>
                    <button type="button" class="remove-procedure-row-btn text-red-500 hover:text-red-700 justify-self-center"><i class="fas fa-trash-alt"></i></button>
                `;
                container.appendChild(procedureRow);
                procedureRow.querySelector('.remove-procedure-row-btn').onclick = () => {
                    container.removeChild(procedureRow);
                };
            };

            // --- RENDERIZAÇÃO DAS ABAS ---
            const renderDashboard = (records) => {
                const today = new Date(); today.setHours(0,0,0,0);
                const thirtyDays = new Date(); thirtyDays.setDate(today.getDate() + 30);
                const vaccineRecords = records.filter(r => r.tipoEvento === 'Vacina');
                const parasiteRecords = records.filter(r => r.tipoEvento === 'Controle Parasitário');
                const overdueVaccines = vaccineRecords.filter(r => r.proximaData.toDate() < today);
                const upcomingVaccines = vaccineRecords.filter(r => r.proximaData.toDate() >= today && r.proximaData.toDate() <= thirtyDays);
                const upcomingParasiteControl = parasiteRecords.filter(r => r.proximaData.toDate() >= today);
                const nextParasiteControlByPet = {};
                upcomingParasiteControl.forEach(rec => { if (!nextParasiteControlByPet[rec.petId] || rec.proximaData.toMillis() < nextParasiteControlByPet[rec.petId].proximaData.toMillis()) { nextParasiteControlByPet[rec.petId] = rec; } });
                const nextParasiteControls = Object.values(nextParasiteControlByPet).sort((a,b) => a.proximaData.toMillis() - b.proximaData.toMillis());
                const renderAlertItem = (rec) => { const pet = allPets.find(p=>p.id===rec.petId); if(!pet) return ''; const { compliant } = checkDaycareCompliance(pet, allRecords); const bgColor = pet.isDaycare && !compliant ? 'bg-orange-200' : 'bg-purple-100'; return `<div class="alert-item text-sm p-2 ${bgColor} rounded mb-1 cursor-pointer hover:bg-opacity-80" data-pet-id="${pet.id}"><strong>${pet.nome}</strong> (Tutor: ${pet.nomeTutor})<br><span class="text-xs">${rec.nomeProduto} - Vence em: ${rec.proximaData.toDate().toLocaleDateString('pt-BR')}</span></div>`; };
                const overdueHtml = overdueVaccines.map(renderAlertItem).join('');
                const upcomingHtml = upcomingVaccines.map(renderAlertItem).join('');
                const parasiteHtml = nextParasiteControls.map(renderAlertItem).join('');
                document.getElementById('dashboard-tab').innerHTML = `<section id="alerts-section"><h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Alertas Preventivos</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-teal-50 p-6 rounded-lg shadow"><h3 class="font-bold text-lg text-red-600 mb-3">Vacinas Vencidas</h3><div>${overdueHtml || '<p class="text-gray-500">Nenhuma vacina vencida.</p>'}</div></div><div class="bg-teal-50 p-6 rounded-lg shadow"><h3 class="font-bold text-lg text-orange-500 mb-3">Vacinas (Próx. 30 Dias)</h3><div>${upcomingHtml || '<p class="text-gray-500">Nenhuma vacina próxima.</p>'}</div></div><div class="bg-teal-50 p-6 rounded-lg shadow"><h3 class="font-bold text-lg text-teal-700 mb-3">Próximo Controle Parasitário</h3><div>${parasiteHtml || '<p class="text-gray-500">Nenhum controle próximo.</p>'}</div></div></div></section>`;
                document.querySelectorAll('.alert-item').forEach(item => { item.addEventListener('click', () => showPetDetailsView(item.dataset.petId)); });
            };
            
            const renderPetsTab = (pets) => {
                const content = `<section id="pets-management"><div class="bg-teal-50 p-6 rounded-lg shadow"><div class="relative text-center mb-4"><h2 class="text-2xl font-semibold text-gray-800">Pets Cadastrados</h2><div class="absolute top-0 right-0"><button id="add-pet-button-main" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 whitespace-nowrap">+ Novo Pet</button></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-purple-200 text-purple-800"><th class="p-3">Nome</th><th class="p-3">Tutor</th><th class="p-3">Contato</th><th class="p-3 text-right">Ações</th></tr></thead><tbody id="pets-list-body">${pets.map(pet => { const { compliant } = checkDaycareCompliance(pet, allRecords); const rowClass = pet.isDaycare && !compliant ? 'bg-orange-200 hover:bg-orange-300' : 'bg-teal-100 hover:bg-teal-200'; const daycareIcon = pet.isDaycare ? `<i class="fas fa-home text-purple-600 ml-2" title="Pet de Creche/Hotel"></i>` : ''; return `<tr class="${rowClass} cursor-pointer border-b border-purple-200" data-pet-id="${pet.id}"><td class="p-3">${pet.nome} ${daycareIcon}</td><td class="p-3">${pet.nomeTutor}</td><td class="p-3">${pet.contatoTutor}</td><td class="p-3 text-right"><button class="edit-pet-btn text-purple-500 hover:text-purple-700 ml-2" data-pet-id="${pet.id}"><i class="fas fa-pen"></i></button><button class="delete-pet-btn text-orange-500 hover:text-orange-700 ml-2" data-pet-id="${pet.id}"><i class="fas fa-trash"></i></button></td></tr>`}).join('')}</tbody></table></div></div></section>`;
                document.getElementById('pets-tab').innerHTML = content;
                attachPetActionListeners();
            };

            const renderReportsTab = (container, records, type) => {
                const title = type === 'Vacina' ? 'Relatório Geral de Vacinas' : 'Relatório Geral de Controle Parasitário'; const header = type === 'Vacina' ? 'Procedimentos' : 'Produtos'; const recordsOfType = records.filter(r => r.tipoEvento === type);
                const groupedByPet = recordsOfType.reduce((acc, record) => { if (!acc[record.petId]) { acc[record.petId] = []; } acc[record.petId].push(record); return acc; }, {});
                const tableBody = Object.keys(groupedByPet).map(petId => { const petRecords = groupedByPet[petId]; const pet = allPets.find(p => p.id === petId); if (!pet) return ''; const productNames = petRecords.map(r => r.nomeProduto).join(', '); const lastApplication = new Date(Math.max(...petRecords.map(r => r.dataAplicacao.toMillis()))); const nextDueDate = new Date(Math.min(...petRecords.map(r => r.proximaData.toMillis()))); const { compliant } = checkDaycareCompliance(pet, allRecords); const rowClass = pet.isDaycare && !compliant ? 'bg-orange-200 hover:bg-orange-300' : 'bg-teal-100 hover:bg-teal-200'; return `<tr class="${rowClass} cursor-pointer border-b border-purple-200" data-pet-id="${pet.id}"><td class="p-3">${pet.nome}</td><td class="p-3">${productNames}</td><td class="p-3">${lastApplication.toLocaleDateString('pt-BR')}</td><td class="p-3">${nextDueDate.toLocaleDateString('pt-BR')}</td></tr>`; }).join('');
                const content = `<div class="bg-teal-50 p-6 rounded-lg shadow"><h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">${title}</h2><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-purple-200 text-purple-800"><th class="p-3">Pet</th><th class="p-3">${header}</th><th class="p-3">Última Aplicação</th><th class="p-3">Próxima Dose Mais Perto</th></tr></thead><tbody>${Object.keys(groupedByPet).length > 0 ? tableBody : `<tr><td colspan="4" class="p-3 text-center text-gray-500">Nenhum registro encontrado.</td></tr>`}</tbody></table></div></div>`;
                container.innerHTML = content;
                container.querySelectorAll('tr[data-pet-id]').forEach(row => { row.addEventListener('click', () => showPetDetailsView(row.dataset.petId)); });
            };

            const renderHealthHistoryForPet = (petId) => {
                const historyContainer = document.getElementById('health-history-list-body'); if (!historyContainer) return;
                const records = allRecords.filter(r => r.petId === petId).sort((a,b) => b.dataAplicacao.toMillis() - a.dataAplicacao.toMillis());
                historyContainer.innerHTML = records.map(record => { const proximaData = record.proximaData.toDate(); const today = new Date(); today.setHours(0,0,0,0); let statusClass = 'bg-green-100 text-green-800', statusText = 'OK'; if (proximaData < today) { statusClass = 'bg-red-100 text-red-800'; statusText = 'Vencido'; } else if ((proximaData - today) / (1000*60*60*24) <= 30) { statusClass = 'bg-orange-100 text-orange-800'; statusText = 'Pendente'; } return `<tr class="bg-teal-100 border-b border-purple-200"><td class="p-3">${record.dataAplicacao.toDate().toLocaleDateString('pt-BR')}</td><td class="p-3">${record.tipoEvento}</td><td class="p-3">${record.nomeProduto}</td><td class="p-3">${proximaData.toLocaleDateString('pt-BR')}</td><td class="p-3"><span class="px-2 py-1 rounded-full text-sm font-semibold ${statusClass}">${statusText}</span></td><td class="p-3 text-right"><button class="edit-record-btn text-purple-500 hover:text-purple-700 ml-2" data-record-id="${record.id}" data-record-type="${record.tipoEvento}"><i class="fas fa-pen"></i></button><button class="delete-record-btn text-orange-500 hover:text-orange-700 ml-2" data-record-id="${record.id}"><i class="fas fa-trash"></i></button></td></tr>`;}).join('');
                document.querySelectorAll('.edit-record-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); const record = allRecords.find(r=>r.id===btn.dataset.recordId); setupRecordModal(btn.dataset.recordType, record); }));
                document.querySelectorAll('.delete-record-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); const recordId = btn.dataset.recordId; const record = allRecords.find(r=>r.id===recordId); const recordName = record ? record.nomeProduto : 'este registro'; openConfirmModal(`Deseja excluir o registro de ${recordName}?`, () => { deleteDoc(doc(db, 'registrosSaude', recordId)); showToast('Registro excluído.'); }); }));
            };

            const renderConsultationsForPet = (petId) => {
                const historyContainer = document.getElementById('consultations-history-list-body'); if (!historyContainer) return;
                const petConsultations = allConsultations.filter(c => c.petId === petId).sort((a,b) => b.dataConsulta.toMillis() - a.dataConsulta.toMillis());
                historyContainer.innerHTML = petConsultations.map(consult => { const retornoDate = consult.dataRetorno ? consult.dataRetorno.toDate().toLocaleDateString('pt-BR') : 'N/A'; return `<tr class="bg-blue-100 border-b border-blue-200"><td class="p-3">${consult.dataConsulta.toDate().toLocaleDateString('pt-BR')}</td><td class="p-3 truncate" title="${consult.queixaPrincipal}">${consult.queixaPrincipal}</td><td class="p-3 truncate" title="${consult.diagnostico}">${consult.diagnostico || 'N/A'}</td><td class="p-3">${retornoDate}</td><td class="p-3 text-right"><button class="view-consultation-btn text-blue-500 hover:text-blue-700 ml-2" data-consult-id="${consult.id}"><i class="fas fa-eye"></i></button><button class="edit-consultation-btn text-purple-500 hover:text-purple-700 ml-2" data-consult-id="${consult.id}"><i class="fas fa-pen"></i></button><button class="delete-consultation-btn text-orange-500 hover:text-orange-700 ml-2" data-consult-id="${consult.id}"><i class="fas fa-trash"></i></button></td></tr>`; }).join('');
                document.querySelectorAll('.view-consultation-btn, .edit-consultation-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); const consult = allConsultations.find(c=>c.id===btn.dataset.consultId); setupConsultationModal(consult); }));
                document.querySelectorAll('.delete-consultation-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); const consultId = btn.dataset.consultId; openConfirmModal(`Deseja excluir esta consulta?`, () => { deleteDoc(doc(db, 'consultas', consultId)); showToast('Consulta excluída.'); }); }));
            };

            const showPetDetailsView = (petId) => {
                currentPetId = petId;
                mainContent.querySelector('#tab-contents').classList.add('hidden');
                mainContent.querySelector('#filters-container').classList.add('hidden');
                petDetailsView.classList.remove('hidden');
                const pet = allPets.find(p => p.id === petId);
                if (!pet) { console.error("Pet não encontrado:", petId); petDetailsView.classList.add('hidden'); mainContent.querySelector('#tab-contents').classList.remove('hidden'); mainContent.querySelector('#filters-container').classList.remove('hidden'); return; }
                const birthDate = pet.dataNascimento.toDate().toLocaleDateString('pt-BR');
                const { compliant } = checkDaycareCompliance(pet, allRecords);
                let complianceBanner = pet.isDaycare ? (compliant ? `<div class="p-3 mb-4 bg-green-100 text-green-800 rounded-lg text-center font-semibold">Este pet está com a saúde em dia para Creche/Hotel.</div>` : `<div class="p-3 mb-4 bg-orange-200 text-orange-800 rounded-lg text-center font-semibold">Atenção: Saúde irregular para Creche/Hotel!</div>`) : '';
                petDetailsView.innerHTML = `${complianceBanner}<button id="back-to-list" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 mb-4">&larr; Voltar</button><div class="bg-teal-50 p-6 rounded-lg shadow"><div class="mb-6 border-b border-purple-200 pb-4 grid grid-cols-1 md:grid-cols-3 gap-2"><div><h2 class="text-2xl font-bold">${pet.nome}</h2><p>${pet.especie} - ${pet.raca}</p></div><div><p>Nascimento: ${birthDate}</p><p>Cor: ${pet.corPelagem || 'N/A'}</p><p>Peso: ${pet.peso ? pet.peso + ' kg' : 'N/A'}</p></div><div><p class="font-semibold">Tutor: ${pet.nomeTutor}</p><p>${pet.contatoTutor}</p></div></div><div class="mb-8"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold text-gray-700">Histórico de Saúde</h3><div><button id="add-vaccine-btn-detail" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 mr-2">+ Vacina</button><button id="add-parasite-btn-detail" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 mr-2">+ Parasitário</button><button id="add-medication-btn-detail" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600">+ Medicamento</button></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-purple-200 text-purple-800"><th class="p-3">Data</th><th class="p-3">Procedimento</th><th class="p-3">Produto</th><th class="p-3">Próxima Dose</th><th class="p-3">Status</th><th class="p-3 text-right">Ações</th></tr></thead><tbody id="health-history-list-body"></tbody></table></div></div><div><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold text-gray-700">Histórico de Consultas</h3><div><button id="add-consultation-btn-detail" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">+ Nova Consulta</button></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-blue-200 text-blue-800"><th class="p-3">Data</th><th class="p-3">Queixa Principal</th><th class="p-3">Diagnóstico</th><th class="p-3">Retorno</th><th class="p-3 text-right">Ações</th></tr></thead><tbody id="consultations-history-list-body"></tbody></table></div></div></div>`;
                document.getElementById('back-to-list').addEventListener('click', () => { petDetailsView.classList.add('hidden'); mainContent.querySelector('#tab-contents').classList.remove('hidden'); mainContent.querySelector('#filters-container').classList.remove('hidden'); currentPetId = null; });
                document.getElementById('add-vaccine-btn-detail').addEventListener('click', () => setupRecordModal('Vacina'));
                document.getElementById('add-parasite-btn-detail').addEventListener('click', () => setupRecordModal('Controle Parasitário'));
                document.getElementById('add-medication-btn-detail').addEventListener('click', () => setupRecordModal('Medicamento'));
                document.getElementById('add-consultation-btn-detail').addEventListener('click', () => setupConsultationModal());
                renderHealthHistoryForPet(petId);
                renderConsultationsForPet(petId);
            };

            // --- FUNÇÃO CENTRAL DE RENDERIZAÇÃO ---
            const applyFiltersAndRender = () => {
                const searchTerm = universalSearch.value.toLowerCase();
                const startDate = startDateFilter.value ? new Date(startDateFilter.value) : null;
                const endDate = endDateFilter.value ? new Date(endDateFilter.value) : null;
                if(startDate) startDate.setHours(0,0,0,0);
                if(endDate) endDate.setHours(23,59,59,999);
                const filteredPetIds = allPets.filter(pet => (pet.nome || '').toLowerCase().includes(searchTerm) || (pet.nomeTutor || '').toLowerCase().includes(searchTerm)).map(pet => pet.id);
                const filteredPets = allPets.filter(pet => filteredPetIds.includes(pet.id));
                let filteredRecords = allRecords.filter(rec => filteredPetIds.includes(rec.petId));
                if (['vaccines', 'parasite-control'].includes(activeTab)) { if (startDate) filteredRecords = filteredRecords.filter(rec => rec.proximaData.toDate() >= startDate); if (endDate) filteredRecords = filteredRecords.filter(rec => rec.proximaData.toDate() <= endDate); }
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                const activeTabContent = document.getElementById(`${activeTab}-tab`);
                if(activeTabContent) activeTabContent.classList.remove('hidden');
                switch (activeTab) { case 'dashboard': renderDashboard(filteredRecords); break; case 'pets': renderPetsTab(filteredPets); break; case 'stock': renderStockTab(); break; case 'vaccines': renderReportsTab(activeTabContent, filteredRecords, 'Vacina'); break; case 'parasite-control': renderReportsTab(activeTabContent, filteredRecords, 'Controle Parasitário'); break; }
            };

            // --- LÓGICA DE NAVEGAÇÃO E FILTROS ---
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    activeTab = button.dataset.tab;
                    mainContent.querySelector('#tab-contents').classList.remove('hidden');
                    petDetailsView.classList.add('hidden');
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById('date-filters').classList.toggle('hidden', !['vaccines', 'parasite-control'].includes(activeTab));
                    universalSearch.value = '';
                    applyFiltersAndRender();
                });
            });
            [universalSearch, startDateFilter, endDateFilter].forEach(el => el.addEventListener('input', applyFiltersAndRender));
            clearFiltersButton.addEventListener('click', () => { startDateFilter.value = ''; endDateFilter.value = ''; applyFiltersAndRender(); });

            // --- LISTENERS DO FIRESTORE ---
            unsubscribeListeners.push(onSnapshot(collection(db, "pets"), s => { allPets = s.docs.map(d=>({id:d.id, ...d.data()})); if(currentPetId) showPetDetailsView(currentPetId); else applyFiltersAndRender(); }));
            unsubscribeListeners.push(onSnapshot(collection(db, "registrosSaude"), s => { allRecords = s.docs.map(d=>({id:d.id, ...d.data()})); if(currentPetId) showPetDetailsView(currentPetId); else applyFiltersAndRender(); }));
            unsubscribeListeners.push(onSnapshot(collection(db, "consultas"), s => { allConsultations = s.docs.map(d=>({id:d.id, ...d.data()})); if(currentPetId) showPetDetailsView(currentPetId); }));
            unsubscribeListeners.push(onSnapshot(collection(db, "produtosEstoque"), s => { allStockProducts = s.docs.map(d=>({id:d.id, ...d.data()})); applyFiltersAndRender(); }));
            unsubscribeListeners.push(onSnapshot(collection(db, "lotesEstoque"), s => { allStockLots = s.docs.map(d=>({id:d.id, ...d.data()})); applyFiltersAndRender(); }));

            // --- MÓDULO DE ESTOQUE ---
            const renderStockTab = () => {
                const stockTabContent = document.getElementById('stock-tab');
                const searchTerm = universalSearch.value.toLowerCase();
                let filteredProducts = allStockProducts.filter(p => {
                    const categoryMatch = stockCategoryFilter === 'Todos' || p.categoria === stockCategoryFilter;
                    const searchMatch = (p.nomeProduto || '').toLowerCase().includes(searchTerm);
                    return categoryMatch && searchMatch;
                });
                stockTabContent.innerHTML = `<div class="bg-teal-50 p-6 rounded-lg shadow"><div class="flex flex-col md:flex-row justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-gray-800">Catálogo de Estoque</h2><div class="flex items-center gap-2 mt-4 md:mt-0"><div id="stock-category-filters" class="flex flex-wrap space-x-2"><button data-category="Todos" class="stock-filter-btn px-3 py-1 text-sm rounded-md ${stockCategoryFilter === 'Todos' ? 'bg-purple-600 text-white' : 'bg-purple-200'}">Todos</button><button data-category="Vacinas" class="stock-filter-btn px-3 py-1 text-sm rounded-md ${stockCategoryFilter === 'Vacinas' ? 'bg-purple-600 text-white' : 'bg-purple-200'}">Vacinas</button><button data-category="Controle Parasitário" class="stock-filter-btn px-3 py-1 text-sm rounded-md ${stockCategoryFilter === 'Controle Parasitário' ? 'bg-purple-600 text-white' : 'bg-purple-200'}">Parasitário</button><button data-category="Medicamentos" class="stock-filter-btn px-3 py-1 text-sm rounded-md ${stockCategoryFilter === 'Medicamentos' ? 'bg-purple-600 text-white' : 'bg-purple-200'}">Medicamentos</button><button data-category="Descartáveis" class="stock-filter-btn px-3 py-1 text-sm rounded-md ${stockCategoryFilter === 'Descartáveis' ? 'bg-purple-600 text-white' : 'bg-purple-200'}">Descartáveis</button></div><button id="add-product-catalog-btn" class="bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">+ Novo Produto</button></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-purple-200 text-purple-800"><th class="p-3">Produto</th><th class="p-3">Categoria</th><th class="p-3">Qtd. Total</th><th class="p-3">Estoque Mínimo</th><th class="p-3">Status</th><th class="p-3 text-right">Ações</th></tr></thead><tbody>${filteredProducts.map(p => { 
                    const lots = allStockLots.filter(l => l.produtoId === p.id);
                    const totalStock = lots.reduce((sum, l) => sum + l.quantidadeAtual, 0);
                    const lotsTooltip = lots.map(l => `${l.quantidadeAtual} (Val: ${l.dataValidade.toDate().toLocaleDateString('pt-BR')})`).join(' | ');
                    let statusClass = 'bg-green-200 text-green-800'; let statusText = 'OK'; 
                    if (totalStock <= 0) { statusClass = 'bg-red-200 text-red-800'; statusText = 'Zerado'; } 
                    else if (totalStock <= p.estoqueMinimoAlerta) { statusClass = 'bg-yellow-200 text-yellow-800'; statusText = 'Baixo'; } 
                    return `<tr class="hover:bg-teal-200 border-b border-purple-200"><td class="p-3 font-medium stock-item-row cursor-pointer" data-product-id="${p.id}">${p.nomeProduto}</td><td class="p-3 stock-item-row cursor-pointer" data-product-id="${p.id}">${p.categoria}</td><td class="p-3 stock-item-row cursor-pointer" data-product-id="${p.id}" title="${lotsTooltip}">${totalStock} ${p.unidade || ''}</td><td class="p-3 stock-item-row cursor-pointer" data-product-id="${p.id}">${p.estoqueMinimoAlerta}</td><td class="p-3 stock-item-row cursor-pointer" data-product-id="${p.id}"><span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">${statusText}</span></td><td class="p-3 text-right"><button title="Baixa Manual de Estoque" class="manual-deduct-btn text-orange-500 hover:text-orange-700 mr-2" data-product-id="${p.id}"><i class="fas fa-arrow-down-wide-short"></i></button><button title="Editar Produto" class="edit-product-catalog-btn text-purple-600 hover:text-purple-800 mr-2" data-product-id="${p.id}"><i class="fas fa-pen-to-square"></i></button><button title="Excluir Produto" class="delete-product-btn text-red-500 hover:text-red-700" data-product-id="${p.id}"><i class="fas fa-trash"></i></button></td></tr>`}).join('') || `<tr><td colspan="6" class="p-4 text-center">Nenhum produto encontrado.</td></tr>`}</tbody></table></div></div>`;
                document.querySelectorAll('.stock-filter-btn').forEach(btn => btn.addEventListener('click', () => { stockCategoryFilter = btn.dataset.category; renderStockTab(); }));
                document.querySelectorAll('.stock-item-row').forEach(row => row.addEventListener('click', () => openStockDetailsModal(row.dataset.productId)));
                document.getElementById('add-product-catalog-btn').addEventListener('click', () => openProductCatalogModal());
                document.querySelectorAll('.edit-product-catalog-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); openProductCatalogModal(btn.dataset.productId); }));
                document.querySelectorAll('.manual-deduct-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); openManualDeductionModal(btn.dataset.productId); }));
                document.querySelectorAll('.delete-product-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); deleteProductHandler(btn.dataset.productId); }));
            };
            const openProductCatalogModal = (productId = null) => {
                productCatalogForm.reset();
                const title = document.getElementById('product-catalog-modal-title');
                if (productId) {
                    title.textContent = "Editar Produto no Catálogo";
                    const product = allStockProducts.find(p => p.id === productId);
                    document.getElementById('product-catalog-id').value = product.id;
                    document.getElementById('product-catalog-name').value = product.nomeProduto;
                    document.getElementById('product-catalog-category').value = product.categoria;
                    document.getElementById('product-catalog-unit').value = product.unidade;
                    document.getElementById('product-catalog-min-stock').value = product.estoqueMinimoAlerta;
                } else {
                    title.textContent = "Adicionar Novo Produto ao Catálogo";
                    document.getElementById('product-catalog-id').value = '';
                }
                openModal(productCatalogModal);
            };
            const openStockDetailsModal = (productId) => { const product = allStockProducts.find(p => p.id === productId); const lots = allStockLots.filter(l => l.produtoId === productId).sort((a,b) => a.dataValidade.toMillis() - b.dataValidade.toMillis()); const modalTitle = document.getElementById('stock-details-modal-title'); const modalContent = document.getElementById('stock-details-content'); modalTitle.textContent = `Detalhes de: ${product.nomeProduto}`; modalContent.innerHTML = `<div class="flex justify-end mb-4"><button id="add-lote-btn" data-product-id="${productId}" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">+ Adicionar Lote</button></div><h3 class="font-semibold mb-2">Lotes Disponíveis:</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-200"><th class="p-2">Qtd. no Lote</th><th class="p-2">Data de Validade</th><th class="p-2">Data de Entrada</th><th class="p-2 text-right">Ações</th></tr></thead><tbody>${lots.map(l => `<tr class="border-b"><td class="p-2">${l.quantidadeAtual}</td><td class="p-2">${l.dataValidade.toDate().toLocaleDateString('pt-BR')}</td><td class="p-2">${l.dataEntrada.toDate().toLocaleDateString('pt-BR')}</td><td class="p-2 text-right"><button title="Ajuste de Estoque (Baixa)" class="adjust-lote-btn text-orange-500 hover:text-orange-700" data-lote-id="${l.id}"><i class="fas fa-minus-circle"></i></button></td></tr>`).join('') || `<tr><td colspan="4" class="p-2 text-center">Nenhum lote cadastrado.</td></tr>`}</tbody></table></div>`; document.getElementById('add-lote-btn').addEventListener('click', (e) => { const prodId = e.target.dataset.productId; document.getElementById('lote-entry-product-id').value = prodId; openModal(document.getElementById('lote-entry-modal')); }); document.querySelectorAll('.adjust-lote-btn').forEach(btn => {btn.addEventListener('click', () => openStockAdjustmentModal(btn.dataset.loteId)); }); openModal(document.getElementById('stock-details-modal')); };
            const openStockAdjustmentModal = (loteId) => { const lote = allStockLots.find(l => l.id === loteId); if(!lote) { showToast("Lote não encontrado!", "error"); return; } stockAdjustmentForm.reset(); document.getElementById('adjustment-lote-id').value = loteId; document.getElementById('adjustment-product-name').textContent = lote.nomeProduto; document.getElementById('adjustment-current-stock').textContent = lote.quantidadeAtual; document.getElementById('adjustment-quantity').max = lote.quantidadeAtual; openModal(stockAdjustmentModal); };
            const openManualDeductionModal = (productId) => { manualDeductionForm.reset(); const product = allStockProducts.find(p => p.id === productId); document.getElementById('deduction-product-id').value = productId; document.getElementById('deduction-product-name').textContent = product.nomeProduto; openModal(manualDeductionModal); };
            const deductFromStockFEFO = async (product, quantityToDeduct) => { if (!product || !product.id) { showToast(`Produto inválido.`, 'error'); return false; } try { await runTransaction(db, async (transaction) => { const lotesQuery = query(collection(db, 'lotesEstoque'), where('produtoId', '==', product.id), where('quantidadeAtual', '>', 0)); const lotesSnap = await getDocs(lotesQuery); const sortedLotes = lotesSnap.docs.map(d => ({...d.data(), id: d.id})).sort((a,b) => a.dataValidade.toMillis() - b.dataValidade.toMillis()); let totalStock = sortedLotes.reduce((sum, lote) => sum + lote.quantidadeAtual, 0); if (totalStock < quantityToDeduct) { throw new Error(`Estoque insuficiente para "${product.nomeProduto}".`); } let remainingToDeduct = quantityToDeduct; for (const lote of sortedLotes) { if (remainingToDeduct <= 0) break; const loteRef = doc(db, 'lotesEstoque', lote.id); const currentLote = (await transaction.get(loteRef)).data(); const quantityInLote = currentLote.quantidadeAtual; const deduction = Math.min(remainingToDeduct, quantityInLote); transaction.update(loteRef, { quantidadeAtual: quantityInLote - deduction }); remainingToDeduct -= deduction; } }); showToast(`Baixa de estoque para "${product.nomeProduto}" realizada.`, 'success'); return true; } catch (e) { console.error("Falha na baixa de estoque:", e); showToast(e.message, 'error'); return false; } };
            const deleteProductHandler = (productId) => { const product = allStockProducts.find(p => p.id === productId); if (!product) return; openConfirmModal(`Tem a certeza que quer excluir o produto "${product.nomeProduto}" e todos os seus lotes? Esta ação não pode ser desfeita.`, () => deleteProductAndLots(productId)); };
            const deleteProductAndLots = async (productId) => { const batch = writeBatch(db); const lotsQuery = query(collection(db, 'lotesEstoque'), where('produtoId', '==', productId)); const lotsSnap = await getDocs(lotsQuery); lotsSnap.forEach(loteDoc => batch.delete(loteDoc.ref)); batch.delete(doc(db, 'produtosEstoque', productId)); await batch.commit(); showToast("Produto e lotes associados foram excluídos.", "success"); };
            
            // --- LISTENERS DE FORMULÁRIOS ---
            petForm.addEventListener('submit', async (e) => { e.preventDefault(); const petId = document.getElementById('pet-id').value; const petData = { nome: document.getElementById('pet-name').value, especie: document.getElementById('pet-species').value, raca: document.getElementById('pet-breed').value, corPelagem: document.getElementById('pet-color').value, peso: parseFloat(document.getElementById('pet-weight').value) || null, dataNascimento: Timestamp.fromDate(new Date(document.getElementById('pet-birthdate').value)), nomeTutor: document.getElementById('tutor-name').value, contatoTutor: document.getElementById('tutor-contact').value, isDaycare: document.getElementById('pet-daycare').checked }; try { if (petId) { await updateDoc(doc(db, 'pets', petId), petData); showToast('Pet atualizado com sucesso!'); } else { await addDoc(collection(db, 'pets'), petData); showToast('Pet adicionado com sucesso!'); } closeModal(petModal); } catch (error) { console.error("Erro ao salvar pet:", error); showToast('Erro ao salvar pet.', 'error'); } });
            consultationForm.addEventListener('submit', async (e) => { e.preventDefault(); const consultId = document.getElementById('consultation-id').value; const newWeight = parseFloat(document.getElementById('consultation-weight').value); const consultData = { petId: currentPetId, dataConsulta: Timestamp.fromDate(new Date(document.getElementById('consultation-date').value)), peso: newWeight, queixaPrincipal: document.getElementById('consultation-complaint').value, exameFisico: document.getElementById('consultation-exam').value, diagnostico: document.getElementById('consultation-diagnosis').value, tratamento: document.getElementById('consultation-treatment').value, dataRetorno: document.getElementById('consultation-followup').value ? Timestamp.fromDate(new Date(document.getElementById('consultation-followup').value)) : null }; try { if (consultId) { await updateDoc(doc(db, 'consultas', consultId), consultData); showToast('Consulta atualizada com sucesso!'); } else { await addDoc(collection(db, 'consultas'), consultData); showToast('Consulta salva com sucesso!'); } if (newWeight) { await updateDoc(doc(db, 'pets', currentPetId), { peso: newWeight }); } closeModal(consultationModal); } catch (error) { console.error("Erro ao salvar consulta:", error); showToast('Erro ao salvar consulta.', 'error'); } });
            productCatalogForm.addEventListener('submit', async (e) => { e.preventDefault(); const productId = document.getElementById('product-catalog-id').value; const productData = { nomeProduto: document.getElementById('product-catalog-name').value, categoria: document.getElementById('product-catalog-category').value, unidade: document.getElementById('product-catalog-unit').value, estoqueMinimoAlerta: parseInt(document.getElementById('product-catalog-min-stock').value, 10) }; try { if (productId) { await updateDoc(doc(db, 'produtosEstoque', productId), productData); showToast('Produto atualizado!'); } else { await addDoc(collection(db, 'produtosEstoque'), productData); showToast('Novo produto adicionado ao catálogo!'); } closeModal(productCatalogModal); } catch (error) { console.error("Erro ao salvar produto:", error); showToast('Erro ao salvar produto.', 'error'); }});
            loteEntryForm.addEventListener('submit', async (e) => { e.preventDefault(); const productId = document.getElementById('lote-entry-product-id').value; const loteData = { produtoId: productId, nomeProduto: allStockProducts.find(p => p.id === productId).nomeProduto, quantidadeAtual: parseInt(document.getElementById('lote-quantity').value, 10), dataEntrada: serverTimestamp(), dataValidade: Timestamp.fromDate(new Date(document.getElementById('lote-expiry').value)) }; try { await addDoc(collection(db, 'lotesEstoque'), loteData); showToast('Lote adicionado com sucesso!', 'success'); closeModal(document.getElementById('lote-entry-modal')); } catch (error) { console.error("Erro ao salvar lote:", error); showToast('Erro ao salvar lote.', 'error'); } });
            stockAdjustmentForm.addEventListener('submit', async (e) => { e.preventDefault(); const loteId = document.getElementById('adjustment-lote-id').value; const quantityToRemove = parseInt(document.getElementById('adjustment-quantity').value, 10); const lote = allStockLots.find(l => l.id === loteId); if (quantityToRemove > lote.quantidadeAtual) { showToast("A quantidade a remover não pode ser maior que o estoque atual do lote.", "error"); return; } const newQuantity = lote.quantidadeAtual - quantityToRemove; try { const loteRef = doc(db, 'lotesEstoque', loteId); await updateDoc(loteRef, { quantidadeAtual: newQuantity }); showToast("Baixa manual realizada com sucesso!", "success"); closeModal(stockAdjustmentModal); closeModal(document.getElementById('stock-details-modal')); } catch(error) { showToast("Erro ao ajustar o estoque.", "error"); console.error("Erro no ajuste de estoque: ", error); } });
            manualDeductionForm.addEventListener('submit', async (e) => { e.preventDefault(); const productId = document.getElementById('deduction-product-id').value; const product = allStockProducts.find(p => p.id === productId); if (!product) { showToast("Produto não encontrado.", "error"); return; } const quantity = parseInt(document.getElementById('deduction-quantity').value, 10); await deductFromStockFEFO(product, quantity); closeModal(manualDeductionModal); });
            
            document.getElementById('product-select').addEventListener('change', (e) => {
                document.getElementById('other-product-container').classList.toggle('hidden', e.target.value !== 'Outros');
            });
            
            recordForm.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const recordId = document.getElementById('record-id').value; 
                const appliedElsewhere = document.getElementById('applied-elsewhere').checked; 
                let productName = document.getElementById('product-select').value;
                let skipStockDeduction = appliedElsewhere;

                if (productName === 'Outros') {
                    productName = document.getElementById('other-product-name').value;
                    skipStockDeduction = true; // "Outros" sempre ignora o estoque
                }
                
                if (!productName) {
                    showToast('Por favor, selecione ou insira um produto.', 'error');
                    return;
                }
                
                const productDetails = allStockProducts.find(p => p.nomeProduto === productName);
                const appDateVal = document.getElementById('application-date').value; 
                const dateParts = appDateVal.split('-'); 
                const appDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2])); 
                let nextDate = new Date(appDate.getTime()); 
                nextDate.setDate(nextDate.getDate() + 365); 
                
                const recordData = { petId: currentPetId, tipoEvento: document.getElementById('record-type').value, nomeProduto: productName, dataAplicacao: Timestamp.fromDate(appDate), proximaData: Timestamp.fromDate(nextDate), aplicadoExternamente: skipStockDeduction }; 
                
                try { 
                    if (recordId) { 
                        await updateDoc(doc(db, 'registrosSaude', recordId), recordData); 
                        showToast('Registro atualizado.'); 
                    } else { 
                        if (skipStockDeduction || !productDetails) {
                            await addDoc(collection(db, 'registrosSaude'), recordData);
                            showToast('Registro adicionado (sem baixa no estoque).');
                        } else {
                            const stockDeducted = await deductFromStockFEFO(productDetails, 1); 
                            if (stockDeducted) { 
                                await addDoc(collection(db, 'registrosSaude'), recordData); 
                                showToast('Registro adicionado e estoque atualizado.'); 
                            } else { 
                                showToast('O registro NÃO foi salvo pois não há estoque suficiente.', 'error'); 
                                return; 
                            } 
                        }
                    } 
                    closeModal(recordModal); 
                } catch (error) { 
                    console.error("Erro ao salvar registro:", error); 
                    showToast('Erro ao salvar registro.', 'error'); 
                } 
            });
        }
    </script>
</body>
</html>
